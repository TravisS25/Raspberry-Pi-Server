<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="description" content="Dashboard" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" >
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" >
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="text-center">Charts</h1>
                    <canvas id="myChart" width="1417" height="708" class="chartjs-render-monitor" style="display: block; width: 1417px; height: 708px;"></canvas>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h3 class="text-center">Record Mode</h3>
                    <div class="row">
                        <form id="record-form">
                            <div class="col-md-12">
                            <input type="radio" class="record-mode" name="record-mode" value="true"> Record | 
                            <input type="radio" class="record-mode" name="record-mode" value="false"> Don't Record
                                <hr /> 
                            </div>
                            <div class="col-md-12">
                                <input type="checkbox" class="record-device" id=record-all name="record-device-all" value="All"> All 
                                <hr /> 
                            </div>
                            {{ range $index, $value := .IsDeviceRecording }}
                                <div class="col-md-12">
                                    <input type="checkbox" class="record-device" name="record-device" value="{{$index}}"> {{$index}}

                                    {{ if $value }}
                                        <span class="pull-right"> Mode: <span class="mode-text" data-device-name="{{$index}}" style="color:green">Recording</span></span>
                                    {{ else }}
                                        <span class="pull-right"> Mode: <span class="mode-text" data-device-name="{{$index}}" style="color:red">Not Recording</span></span>
                                    {{ end }}
                                </div> 
                                <!-- <div class="col-md-5">
                                    <input type="checkbox" class="record-device" name="record-device" value="{{$index}}"> {{$index}}
                                </div> 
                                <div class="col-md-7">
                                    {{ if $value }}
                                        Mode: <span class="mode-text" data-device-name="{{$index}}" style="color:green">Record</span>
                                    {{ else }}
                                        Mode: <span class="mode-text" data-device-name="{{$index}}" style="color:red">Don't Record</span>
                                    {{ end }}
                                </div>   -->
                            {{ end }}
                            <div class="col-md-12">
                                <div class="form-group">
                                    <input type="text" name="password" class="form-control" id="record-password" placeholder="Password">
                                </div>
                                <button type="button" id="record-submit" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="col-md-6">
                    <h3 class="text-center">New Set</h3>
                    <div class="row">
                        <form id="new-set-form">
                            <div class="col-md-12">
                                <input type="checkbox" id=new-set-all name="new-set-all"> All 
                                <hr />
                            </div>
                            {{ range $index, $value := .DeviceSet }}
                                <div class="col-md-12">
                                    <input type="checkbox" class="new-set" name="new-set" value="{{$index}}"> {{$index}}
                                    <span class="pull-right">Set: <span class="new-set-text" data-new-set-device="{{ $index }}">{{ $value }}</span></span>
                                </div> 
                            {{ end }}
                            <div class="col-md-12">
                                <div class="form-group">
                                    <input type="text" name="password" class="form-control" id="new-set-password" placeholder="Password">
                                </div>
                                <button type="button" id="new-set-submit" name="new-set-submit" class="btn btn-primary">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h3 class="text-center">Choose Chart</h3>
                    <input type="radio" class="chart-radio" id=hour-chart name="chart-radio"> 1 Hour <br/>
                    <input type="radio" class="chart-radio" id=day-chart name="chart-radio"> 24 Hour <br/>
                    <input type="radio" class="chart-radio" id=week-chart name="chart-radio"> Week
                </div>
                <div class="col-md-6">
                    <h3 class="text-center">Warnings</h3>
                    <div id="warning-section" style="color:red; font-size:16px"></div>
                    <div id="device-message" style="color:red; font-size:16px"></div>
                </div>
            </div>
            <div class="row" style="margin: 25px 0 0 0;">
                <div class="col-md-12">
                    <table id=device-table class="table">
                        <tr>
                            <th><input type="checkbox" id="check-all-sets" /></th>
                            <th>Device Name</th>
                            <th># of Sets</th>
                            <th></th>
                        </tr>
                        {{ range $index, $value := .DeviceSet }}
                            <tr>
                                <td><input type="checkbox" class="all-device-sets" /></td>
                                <td>(Device Name)</td>
                                <td>(# of sets)</td>
                                <td><button class="btn btn-success device-set-button">Device Sets</button></td>
                            </tr>
                        {{end}}
                    </table>
                </div>
            </div>
        </div>
    </body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javacsript"></script>

    <script>
        function updateChartHandler(timeMeasure){
            $.ajax({
                url: "/update-chart-handler/",
                method: "GET",
                data: {timeMeasure: timeMeasure},
                success: function(result){
            
                },
                error: function(xhr, status, stringMessage){
                    toastr.error(xhr.responseText);
                }
            });
        }

        function newSetSubmitHandler(){
            $("#new-set-submit").on("click", function(e){
                var serialize = $("#new-set-form").serialize();
                $.ajax({
                    url: "/new-set/",
                    method: "POST",
                    data: serialize,
                    success: function(result){
                        toastr.success("New set created for selected devices");
                        $("#new-set-password").val("");
                        $("#new-set-all").prop('checked', false);
                        $(".new-set").each(function(i, item){
                            $(this).prop('checked', false);
                        });
                        var result = JSON.parse(result);
                        console.log(result);

                        if(result.message != "" && result.message != null){
                            $("#device-message").html(result.message);
                        }
                        else{
                            $("#device-message").html("");
                        }
                        
                        $(".new-set-text").each(function(i, item){
                            var deviceName = $(this).attr('data-new-set-device');
                            var setNumber = result.deviceSet[deviceName];
                            $(this).html(setNumber);
                        });
                    },
                    error: function(xhr, status, message){
                        toastr.error(xhr.responseText);
                    }
                })
            });
        }

        function statusesHandler(){
            $.ajax({
                url: "/update-status-handler/",
                success: function(result){
                    var result = JSON.parse(result),
                        displayString = "";

                    if(Object.keys(result).length === 0){
                        $("#warning-section").html("");
                    }
                    else{
                        for (var property in result) {
                            if (result.hasOwnProperty(property)) {
                                displayString += "Last heard device '" + property + "' at " + moment(result[property]).format("MM/DD/YYYY H:mm:ss") + " <br />";
                                console.log(result[property]);
                            }
                        }
                        $("#warning-section").html(displayString);
                    }
                },
                error: function(xhr, status, message){

                }
            });
        }

        function recordSubmitHandler(){
            $("#record-submit").on("click", function(e){
                var serialize = $("#record-form").serialize();
                $.ajax({
                    url: "/record-mode-handler/",
                    data: serialize,
                    method: "POST",
                    success: function(result){
                        var result = JSON.parse(result);
                        $(".mode-text").each(function(i, item){
                            var deviceName = $(this).attr('data-device-name');
                            console.log(deviceName);
                            var recordMode = result[deviceName];
                            console.log(recordMode);
                            if(recordMode){
                                $(this).css('color', 'green').html("Recording");
                            }else{
                                $(this).css('color', 'red').html("Not Recording");
                            }

                            $("#record-password").val("");
                            $(".record-device").each(function(i, item){
                                $(this).prop('checked', false);
                            });
                        });
                        console.log(result);
                        toastr.success("Record mode has been changed for selected devices");
                    },
                    error: function(xhr, status, message){
                        toastr.error(xhr.responseText);
                    }
                });
            });
        }

        function substractSet(){
            $(".new-set-text").each(function(i, item){
                var setNumber = parseInt($(this).html()) - 1;
                $(this).html(setNumber);
            });
        }

        function newSetCheckboxHandler(){
            $("#new-set-all").on("click", function(e){
                if($(this).is(":checked")){
                    $(".new-set").each(function(i, item){
                        $(this).prop('checked', true);
                    });
                }
                else{
                    $(".new-set").each(function(i, item){
                        $(this).prop('checked', false);
                    });
                }
            });
        }

        function recordCheckboxHandler(){
            $("#record-all").on("click", function(e){
                if($(this).is(":checked")){
                    $(".record-device").each(function(i, item){
                        $(this).prop('checked', true);
                    });
                }
                else{
                    $(".record-device").each(function(i, item){
                        $(this).prop('checked', false);
                    });
                }
            });
        }

        function initChart(){

        }

        $(document).ready(function(){
            
        var MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        var minutes = ["10", "20", "30", "40", "50", "60"];
        var hours = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23"];
        var ctx = document.getElementById('myChart').getContext('2d');
        var config = {
            type: 'line',
            data: {
                labels: hours,
                datasets: [{
                    label: "Device 1",
                    backgroundColor: "#f44242",
                    borderColor: "#f44242",
                    data: [
                        10,
                        35,
                        25,
                        50,
                        70,
                        15,
                        45
                    ],
                    fill: false,
                }, {
                    label: "Device 2",
                    fill: false,
                    backgroundColor: "#4141f4",
                    borderColor: "#4141f4",
                    data: [
                        20,
                        10,
                        60,
                        50,
                        80,
                        30,
                        50
                    ],
                }]
            },
            options: {
                // responsive: true,
                title:{
                    display:true,
                    text:'24 Hour'
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Movement'
                        }
                    }]
                }
            }
        };
        var chart = new Chart(ctx, config);
        // window.myLine.update();

        // document.getElementById('randomizeData').addEventListener('click', function() {
        //     config.data.datasets.forEach(function(dataset) {
        //         dataset.data = dataset.data.map(function() {
        //             return randomScalingFactor();
        //         });

        //     });

        //     window.myLine.update();
        // });

        // var colorNames = Object.keys(window.chartColors);
        // document.getElementById('addDataset').addEventListener('click', function() {
        //     var colorName = colorNames[config.data.datasets.length % colorNames.length];
        //     var newColor = window.chartColors[colorName];
        //     var newDataset = {
        //         label: 'Dataset ' + config.data.datasets.length,
        //         backgroundColor: newColor,
        //         borderColor: newColor,
        //         data: [],
        //         fill: false
        //     };

        //     for (var index = 0; index < config.data.labels.length; ++index) {
        //         newDataset.data.push(randomScalingFactor());
        //     }

        //     config.data.datasets.push(newDataset);
        //     window.myLine.update();
        // });

        // document.getElementById('addData').addEventListener('click', function() {
        //     if (config.data.datasets.length > 0) {
        //         var month = MONTHS[config.data.labels.length % MONTHS.length];
        //         config.data.labels.push(month);

        //         config.data.datasets.forEach(function(dataset) {
        //             dataset.data.push(randomScalingFactor());
        //         });

        //         window.myLine.update();
        //     }
        // });

        // document.getElementById('removeDataset').addEventListener('click', function() {
        //     config.data.datasets.splice(0, 1);
        //     window.myLine.update();
        // });

        // document.getElementById('removeData').addEventListener('click', function() {
        //     config.data.labels.splice(-1, 1); // remove the label first

        //     config.data.datasets.forEach(function(dataset, datasetIndex) {
        //         dataset.data.pop();
        //     });

        //     window.myLine.update();
        // });
    

            $(".record-mode").first().prop('checked', true);
            $(".chart-radio").first().prop('checked', true);
            newSetCheckboxHandler();
            recordCheckboxHandler();
            recordSubmitHandler();
            newSetSubmitHandler();
            substractSet();
            // getData("all");
            window.setInterval(statusesHandler, 1000);
        });
    </script>

</html>
